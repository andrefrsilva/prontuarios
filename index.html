<!-- ===== PRONTUARIOS.PT – Catálogo com QR dinâmicos + Pop-up de captação ===== -->
<!-- Colar num gadget HTML/JavaScript OU numa página estática do Blogger -->
<style>
  :root {
    --bg: #0b0f14;
    --card: #121923;
    --muted: #7a8aa0;
    --accent: #3ba0ff;
    --accent-2: #59d0a0;
    --text: #eaf0f6;
    --ring: rgba(59,160,255,.35);
    --shadow: 0 8px 24px rgba(0,0,0,.35);
    --radius: 18px;
  }
  .qr-wrapper { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color: var(--text); }
  .qr-shell { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
  .qr-head { display:flex; flex-wrap:wrap; align-items:center; gap:12px; justify-content:space-between; margin-bottom:22px; }
  .qr-title { font-size: clamp(20px, 2.5vw, 28px); font-weight: 700; letter-spacing:.2px; }
  .qr-panel { background: linear-gradient(180deg, #0f1520, #0c131c); border:1px solid #213043; box-shadow: var(--shadow); border-radius: var(--radius); padding:14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .qr-field { display:flex; gap:10px; align-items:center; flex: 1 1 340px; }
  .qr-field label { font-size:13px; color: var(--muted); white-space:nowrap; }
  .qr-field input { flex:1; background:#0d141d; border:1px solid #1e2a3a; color:var(--text); padding:10px 12px; border-radius: 12px; outline:none; box-shadow: inset 0 0 0 0 transparent; transition: box-shadow .2s, border-color .2s; }
  .qr-field input:focus { border-color:#2a3e57; box-shadow: 0 0 0 4px var(--ring); }
  .qr-btn { appearance:none; border:0; background: linear-gradient(135deg, var(--accent), #6dc3ff); color:#041421; font-weight:700; padding:10px 16px; border-radius:12px; cursor:pointer; transition: transform .06s ease; }
  .qr-btn:active { transform: translateY(1px); }
  .qr-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:16px; margin-top:18px; }
  .qr-card { background: var(--card); border:1px solid #1f2a3a; border-radius: var(--radius); box-shadow: var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px; }
  .qr-badge { font-size:12px; color:#a9b7c9; letter-spacing:.3px; }
  .qr-name { font-size:18px; font-weight:700; line-height:1.25; }
  .qr-qrcode { display:grid; place-items:center; background: #0b121b; border:1px dashed #243246; border-radius:14px; padding:10px; min-height: 164px; }
  .qr-cta { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .qr-link { font-size:12px; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 70%; }
  .qr-copy { font-size:12px; border:1px solid #1f2a3a; padding:6px 10px; border-radius:10px; background:#0f1520; color:#cfe4ff; cursor:pointer; }
  .qr-footer { margin-top: 24px; font-size:12px; color: var(--muted); }
  .qr-success { color: var(--accent-2); font-weight:600; }

  /* Modal (pop-up) */
  .qr-modal-backdrop { position: fixed; inset:0; background: rgba(3,8,15,.72); backdrop-filter: blur(4px); display:none; align-items:center; justify-content:center; z-index: 9999; }
  .qr-modal { width:min(720px, 92vw); background: linear-gradient(180deg, #0f1520, #0a1018); border:1px solid #26364d; border-radius: 20px; padding: 18px; box-shadow: 0 20px 60px rgba(0,0,0,.55); }
  .qr-modal h3 { margin:0 0 6px; font-size:22px; }
  .qr-modal p { margin:0 0 12px; color: var(--muted); font-size:14px; }
  .qr-form { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
  .qr-form .full { grid-column: 1 / -1; }
  .qr-form input, .qr-form textarea { width:100%; background:#0d141d; border:1px solid #1e2a3a; color:var(--text); padding:10px 12px; border-radius:12px; outline:none; }
  .qr-form textarea { min-height: 110px; resize: vertical; }
  .qr-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
  .btn-sec { background:#0e1520; border:1px solid #26364d; color:#cde1f8; padding:10px 14px; border-radius:12px; cursor:pointer; }
  .btn-pri { background: linear-gradient(135deg, var(--accent-2), #78e3b3); color:#062017; font-weight:800; padding:10px 16px; border-radius:12px; cursor:pointer; border:0; }
  .qr-hide { display:none !important; }

  /* Dark page background (opcional) */
  body { background: var(--bg); }
</style>

<div class="qr-wrapper">
  <div class="qr-shell">
    <div class="qr-head">
      <div class="qr-title">Catálogo · QR dinâmicos</div>
      <div class="qr-panel" role="group" aria-label="Controlo de QR Codes">
        <div class="qr-field">
          <label for="affiliateInput">Affiliate</label>
          <input id="affiliateInput" type="text" placeholder="ex.: afiliado_joao" autocomplete="off" />
        </div>
        <button class="qr-btn" id="btnAtualizar">Atualizar QR Codes</button>
        <span id="statusMsg" class="qr-badge"></span>
      </div>
    </div>

    <!-- ===== CATÁLOGO =====
         Duplicar .qr-card para adicionar produtos. O nome do produto vem de data-product.
    -->
    <div class="qr-grid" id="catalogo">
      <div class="qr-card" data-product="Manual de Onboarding">
        <div class="qr-badge">Produto</div>
        <div class="qr-name">Manual de Onboarding</div>
        <div class="qr-qrcode" data-qr></div>
        <div class="qr-cta">
          <span class="qr-link" data-link>—</span>
          <button class="qr-copy" data-copy>Copiar URL</button>
        </div>
      </div>

      <div class="qr-card" data-product="Template de Proposta">
        <div class="qr-badge">Produto</div>
        <div class="qr-name">Template de Proposta</div>
        <div class="qr-qrcode" data-qr></div>
        <div class="qr-cta">
          <span class="qr-link" data-link>—</span>
          <button class="qr-copy" data-copy>Copiar URL</button>
        </div>
      </div>

      <div class="qr-card" data-product="Checklist de Auditoria">
        <div class="qr-badge">Produto</div>
        <div class="qr-name">Checklist de Auditoria</div>
        <div class="qr-qrcode" data-qr></div>
        <div class="qr-cta">
          <span class="qr-link" data-link>—</span>
          <button class="qr-copy" data-copy>Copiar URL</button>
        </div>
      </div>
    </div>

    <div class="qr-footer">
      ⚙️ Dica: o valor do affiliate fica gravado no teu navegador (localStorage).
      <span id="lastAction" class="qr-success"></span>
    </div>
  </div>
</div>

<!-- ===== MODAL (aparece quando a página abre com ?p=...&a=...) ===== -->
<div class="qr-modal-backdrop" id="qrModalBackdrop" aria-hidden="true">
  <div class="qr-modal" role="dialog" aria-modal="true" aria-labelledby="qrModalTitle">
    <h3 id="qrModalTitle">Pedido de informação</h3>
    <p>Preenche os campos. O teu pedido será encaminhado internamente.</p>

    <form id="leadForm" class="qr-form" novalidate>
      <input type="hidden" name="entry.698615008" id="gformProduto" /> <!-- produto -->
      <input type="hidden" name="entry.645159200" id="gformAfiliado" /> <!-- affiliate -->
      <input type="hidden" name="entry.1002593961" id="gformTexto" /> <!-- bloco de texto agregado -->

      <div>
        <label for="nome">Nome</label>
        <input id="nome" type="text" placeholder="O teu nome (opcional)" />
      </div>
      <div>
        <label for="contacto">Contacto</label>
        <input id="contacto" type="text" placeholder="Email ou telemóvel (opcional)" />
      </div>
      <div class="full">
        <label for="mensagem">Mensagem</label>
        <textarea id="mensagem" placeholder="Escreve aqui a tua mensagem (opcional)"></textarea>
      </div>

      <div class="qr-actions full">
        <button type="button" class="btn-sec" id="btnFechar">Fechar</button>
        <button type="submit" class="btn-pri">Enviar</button>
      </div>
      <p id="formStatus" class="qr-badge full"></p>
    </form>
  </div>
</div>

<!-- ===== QRCode.js (CDN) ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<script>
(function () {
  const SITE_BASE = "https://prontuarios.pt/"; // domínio do site
  const FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSflzspmuBWoD3OA5cISJBwFWuLlIoYNpBAYi9KuG-fs2VYMjA/formResponse";

  // Elementos principais
  const $affiliateInput = document.getElementById("affiliateInput");
  const $btnAtualizar = document.getElementById("btnAtualizar");
  const $statusMsg = document.getElementById("statusMsg");
  const $lastAction = document.getElementById("lastAction");
  const $catalogo = document.getElementById("catalogo");

  // Modal & Form
  const $backdrop = document.getElementById("qrModalBackdrop");
  const $leadForm = document.getElementById("leadForm");
  const $btnFechar = document.getElementById("btnFechar");
  const $formStatus = document.getElementById("formStatus");

  const $gProduto = document.getElementById("gformProduto");
  const $gAfiliado = document.getElementById("gformAfiliado");
  const $gTexto = document.getElementById("gformTexto");

  // Utils
  const qs = (sel, ctx = document) => ctx.querySelector(sel);
  const qsa = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
  const enc = encodeURIComponent;

  function setStatus(msg, ok=false) {
    $statusMsg.textContent = msg;
    $statusMsg.style.color = ok ? "var(--accent-2)" : "var(--muted)";
  }

  function saveAffiliateLocal(value) {
    try { localStorage.setItem("prontuarios_affiliate", value || ""); } catch {}
  }

  function loadAffiliateLocal() {
    try { return localStorage.getItem("prontuarios_affiliate") || ""; } catch {}
    return "";
  }

  function buildProductUrl(product, affiliate) {
    const url = new URL(SITE_BASE);
    url.searchParams.set("p", product);
    url.searchParams.set("a", affiliate);
    return url.toString();
  }

  function clearNode(el) { while (el.firstChild) el.removeChild(el.firstChild); }

  // Gera/regera todos os QR codes com o affiliate atual
  function regenerateQRCodes() {
    const affiliate = ($affiliateInput.value || "").trim();
    if (!affiliate) {
      setStatus("⚠️ Introduz um affiliate e clica em Atualizar.");
      return;
    }
    saveAffiliateLocal(affiliate);

    const cards = qsa(".qr-card", $catalogo);
    cards.forEach((card) => {
      const product = card.getAttribute("data-product") || qs(".qr-name", card)?.textContent.trim() || "Produto";
      const link = buildProductUrl(product, affiliate);

      // Mostra URL curto no cartão (apenas para debug/partilha rápida)
      const linkEl = qs("[data-link]", card);
      if (linkEl) linkEl.textContent = link;

      // Botão copiar
      const btnCopy = qs("[data-copy]", card);
      if (btnCopy) {
        btnCopy.onclick = async () => {
          try { await navigator.clipboard.writeText(link); btnCopy.textContent = "Copiado!"; setTimeout(()=>btnCopy.textContent="Copiar URL", 1200); }
          catch { alert(link); }
        };
      }

      // Gera QR
      const qrBox = qs("[data-qr]", card);
      if (qrBox) {
        clearNode(qrBox);
        // Aguarda carregamento do QRCode.js caso o defer ainda não tenha corrido
        if (typeof QRCode === "undefined") {
          setTimeout(() => regenerateQRCodes(), 150);
          return;
        }
        new QRCode(qrBox, {
          text: link,
          width: 150,
          height: 150,
          correctLevel: QRCode.CorrectLevel.M
        });
      }
    });

    setStatus("✅ QR Codes atualizados.", true);
    $lastAction.textContent = " · Affiliate ativo: " + affiliate;
  }

  // Inicializa valores guardados
  $affiliateInput.value = loadAffiliateLocal();
  if ($affiliateInput.value) {
    // pré-gerar quando já existe affiliate guardado
    window.addEventListener("load", regenerateQRCodes);
  }

  // Botão "Atualizar"
  $btnAtualizar.addEventListener("click", regenerateQRCodes);

  // ===== LADO “DESTINO” – quando o visitante chega com ?p=...&a=... abre o modal
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  function openModal() {
    $backdrop.style.display = "flex";
    $backdrop.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    $backdrop.style.display = "none";
    $backdrop.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }

  $btnFechar.addEventListener("click", closeModal);
  $backdrop.addEventListener("click", (e) => { if (e.target === $backdrop) closeModal(); });

  // Se vier com parâmetros, abrir pop-up e preencher escondidos
  function handleLanding() {
    const product = getParam("p");
    const affiliate = getParam("a");
    if (!product || !affiliate) return; // sem parâmetros, não abre
    // Preenche campos escondidos para o Google Forms
    $gProduto.value = product;
    $gAfiliado.value = affiliate;
    openModal();
  }

  // Submissão do formulário ao Google Forms
  $leadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    $formStatus.textContent = "A enviar…";

    const nome = (document.getElementById("nome").value || "").trim();
    const contacto = (document.getElementById("contacto").value || "").trim();
    const mensagem = (document.getElementById("mensagem").value || "").trim();

    // Monta bloco de texto para entry.1002593961
    const blocos = [];
    if (nome) blocos.push(`Nome: ${nome}`);
    if (contacto) blocos.push(`Contacto: ${contacto}`);
    if (mensagem) blocos.push(`Mensagem: ${mensagem}`);
    const textoAgregado = blocos.join("\n");

    $gTexto.value = textoAgregado;

    // Construir payload (como application/x-www-form-urlencoded)
    const formData = new URLSearchParams();
    formData.set("entry.698615008", $gProduto.value);    // Nome do produto
    formData.set("entry.645159200", $gAfiliado.value);   // Affiliate
    formData.set("entry.1002593961", $gTexto.value);     // Texto agregado

    try {
      const resp = await fetch(FORM_ACTION, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: formData.toString(),
        mode: "no-cors" // Google Forms não devolve CORS; consideramos envio concluído.
      });
      // Como não há CORS, assumimos sucesso se não houve erro de rede.
      $formStatus.textContent = "✅ Pedido enviado. Obrigado!";
      // Limpeza opcional
      $leadForm.reset();
      setTimeout(() => closeModal(), 900);
    } catch (err) {
      console.error(err);
      $formStatus.textContent = "⚠️ Ocorreu um erro ao enviar. Tenta novamente.";
    }
  });

  // Arranque
  handleLanding();
})();
</script>
<!-- ===== FIM ===== -->
